var Sitesearch=function(a,b){this.results=[];this.input=null;this.hook=null;this.overlay=null;this.timeout=null;this.prev_q="";this.search_timeout=300;this.min_chars=2;this.cache={};this.props={classes:{overlay:"sr-overlay",row:"game-icon",info_wrapper:"sr-info-wrapper",title:"sr-title",descr:"sr-desc",more_button:"sr-more-button"},ids:{row_prefix:"sr-row-"}};this.input=$(a);if(this.input.length===0){throw ('Input "'+a+'" not found!')}this.hook=$(b);if(this.hook.length===0){throw ('Input "'+b+'" not found!')}this.input.focus($.proxy(function(d){if(this.input.val()&&!this.overlayExists()){this.search()}},this));var c=this;this.input.blur($.proxy(function(){setTimeout(function(){c.destroyOverlay()},500)},this));this.input.keydown($.proxy(function(d){this.handleOnKeyDown(d)},this));this.input.keyup($.proxy(function(d){this.handleOnKeyUp(d)},this));this.overlayExists=function(){return(this.overlay!==null)};this.showOverlay=function(){if(this.overlayExists()){this.clearOverlay()}else{this.overlay=$("<div></div>").addClass(this.props.classes.overlay);$("body").append(this.overlay);this.overlay.css("display","block");this.overlay.css("position","absolute");this.overlay.attr("id","search-suggestions");var d=this.hook.offset();this.overlay.css("top",d.top+this.hook.outerHeight());this.overlay.css("left",d.left)}};this.destroyOverlay=function(){if(this.overlayExists()){this.input.removeClass("search-active");this.overlay.remove();this.overlay=null;$("#game-container").stop().animate({"margin-top":0},250)}};this.clearOverlay=function(){if(this.overlayExists()){this.overlay.html("")}};this.populateOverlay=function(){this.showOverlay();this.clearOverlay();$("#game-container").stop().animate({"margin-top":340},250);this.input.addClass("search-active");var d=$("<ul></ul>");if(this.input.val().toLowerCase().indexOf("free")>=0){d.append('<li class="free-games">'+translate.search_free_games+"</li>")}$(this.results).each($.proxy(function(g,n){if(n.is_more_button!==true){var m=$("<li></li>"),l=$("<a></a>");if(n.entry_type==="hub"){l.attr("href",n.hub_url_key)}else{if(n.entry_type==="category"){l.attr("href","/games/genre-"+n._id+"/")}else{l.attr("href","/games/"+n.game_url_key+"/")}}l.addClass(this.props.classes.row).attr("id",this.props.ids.row_prefix+n._id);if(n.highlighted===true){l.addClass("highlighted")}l.attr("qs_phrase",this.input.val());l.attr("qs_key",n.game_url_key);l.click(function(){statTracker("/elastic-search/search/"+$(this).attr("qs_phrase"));statTracker("/elastic-search/play/"+$(this).attr("qs_key"))});var h=new Image();if(n.entry_type=="game"&&n.icon_filename!=""&&n.icon_filename!=null){h.src="/content/game-icons/small/"+n.icon_filename+".jpg"}else{if(n.entry_type==="hub"){h.src="/layout/icons/hubs/"+n._id+".jpg"}else{h.src="/i/creatives/icons/defaultsmallicon.jpg"}}var f=$("<span></span>").append(h).addClass("icon-wrap");f.css("width","auto");f.css("height","auto");l.append(f);var k=$('<span class="game-name">'+n.name+"</span>");l.append(k);var j=n.short_description?n.short_description:n.description?n.description:"";var e=$('<span class="game-description">'+j+"</span>");l.append(e);l.bind("mouseover",$.proxy(function(i){this.removeAllHighlights();this.results[g].highlighted=true;this.updateHighlights(n)},this));l.bind("mousedown",$.proxy(function(i){if(n.is_more_button){this.input.closest("form").submit();return false}},this));m.append(l);d.append(m)}},this));this.overlay.append(d);if(this.input.val().length>0){this.overlay.append('<div class="action-button orange"><a href="/games/search/en/?query='+encodeURIComponent(this.input.val().toLowerCase())+'">'+translate.show_more_results+"</a></div>")}else{this.overlay.append('<div class="action-button orange"><a href="/games/search/en/">'+translate.show_more_results+"</a></div>")}};this.showNoResultsOverlay=function(){};this.updateHighlights=function(d){if(!this.overlayExists()){return}if(!d){this.removeAllHighlights();return}var e=this.props.ids.row_prefix+d._id;this.overlay.find("a").each(function(g,f){f=$(f);if(f.attr("id")==e){f.addClass("highlighted")}else{f.removeClass("highlighted")}})};this.getHighlightedItem=function(){for(var d=0;d<this.results.length;d++){if(this.results[d].highlighted===true){return this.results[d]}}return null};this.removeAllHighlights=function(){for(var d=0;d<this.results.length;d++){this.results[d].highlighted=false}this.overlay.find("a").each(function(f,e){$(e).removeClass("highlighted")})};this.handleOnKeyDown=function(d){if(d.keyCode==13){return this.handleReturn(d)}};this.handleOnKeyUp=function(d){if(this.input.val()!==this.prev_q){this.prev_q=this.input.val().toLowerCase();clearTimeout(this.timeout);var e=this;this.timeout=setTimeout(function(){e.search()},this.search_timeout);return}if(d.keyCode==38){return this.handleArrowUp(d)}else{if(d.keyCode==27){return this.destroyOverlay()}else{if(d.keyCode==40){return this.handleArrowDown(d)}else{if(d.keyCode==13){return this.handleReturn(d)}}}}};this.handleArrowDown=function(g){if(this.results.length>0){var e=null;if(this.results.length>1){var d=this.results.length-1;for(var f=0;f<this.results.length;f++){if(this.results[f].highlighted===true){if(f<d){this.results[f].highlighted=false;this.results[f+1].highlighted=true;e=this.results[f+1];break}else{return}}}}if(e===null){this.results[0].highlighted=true;e=this.results[0]}this.updateHighlights(e)}return false};this.handleArrowUp=function(f){if(this.results.length>0){var d=null;if(this.results.length>1){for(var e=0;e<this.results.length;e++){if(this.results[e].highlighted===true){this.results[e].highlighted=false;if(e>0){this.results[e-1].highlighted=true;d=this.results[e-1]}break}}}this.updateHighlights(d)}return false};this.handleReturn=function(f){var e=this.getHighlightedItem();$(f.target.form).submit(function(g){return true});if(e){if(e.is_more_button!==true){$(f.target.form).submit(function(g){return false});statTracker("/elastic-search/search/"+this.input.val().toLowerCase());statTracker("/elastic-search/play/"+e.game_url_key+"/");if(e.entry_type=="hub"){window.location.href=e.hub_url_key}else{if(e.entry_type=="category"){var d="/games/genre-"+e._id+"/"+e.slug+"/en/";window.location.href=d}else{window.location.href="/games/"+e.game_url_key+"/"}}return false}}f.target.form.submit();return false};this.search=function(){var f=this.input.val().toLowerCase();if(f.length<this.min_chars){this.destroyOverlay();return}if(this.cache[f]!==undefined){if(this.cache[f]!==false){this.results=this.cache[f];this.populateOverlay()}else{this.showNoResultsOverlay()}return}var d="/games/ajax/gamesearch/";var e={query:f};$.ajax({url:d,data:e,dataType:"json",type:"GET",success:$.proxy(function(g){if(g.success&&g.result.length){this.results=[];$(g.result).each($.proxy(function(h,i){i.highlighted=(h===0);this.results.push(i)},this));this.results.push({_id:"more",is_more_button:true,highlighted:false});this.cache[f]=this.results;this.populateOverlay()}else{this.cache[f]=false;this.showNoResultsOverlay()}},this)})}};$(function(){if($("#search-text").length>=1){new Sitesearch("#search-text","#search-form")}});