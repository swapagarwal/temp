(function(a){a.SmartTextBox={};var b=a.SmartTextBox;b.BaseClass=function(c){};b.BaseClass.prototype.construct=function(){};b.BaseClass.extend=function(g){var c=function(){if(arguments[0]!==b.BaseClass){this.construct.apply(this,arguments)}};var f=new this(b.BaseClass);var d=this.prototype;for(var h in g){var e=g[h];f[h]=e}c.prototype=f;c.extend=this.extend;return c};b.SmartTextBox=b.BaseClass.extend({_options:{autocomplete:true,minSearchLength:2,maxResults:10,caseSensitive:false,highlight:true,fullSearch:true,autocompleteValues:[],autocompleteUrl:null,placeholder:"Please start typing to receive suggestions",onlyAutocomplete:false,uniqueValues:true,submitKeys:[13],submitChars:[";",","],separator:";",updateOriginal:true,onElementAdd:null,onElementRemove:null,onElementFocus:null,onElementBlur:null,hideEmptyInputs:true,editOnFocus:false,editOnDoubleClick:false,containerClass:"smartTextBox",debug:false},construct:function(d,e){this.options={};var e=e||{};a.extend(this.options,this._options);a.extend(this.options,e);var c=this;this.original=a(d);this.focused=false;this.elements=[];a(this.original).data("SmartTextBox",this);this.original.hide();this.container=a("<div></div>").addClass(this.options.containerClass).click(function(f){if((c.container.index(f.target)>-1||c.list.index(f.target)>-1)&&(!c.currentFocus||c.currentFocus!=c.elements[c.elements.length-1])){c.focusLast()}}).insertAfter(this.original);this.list=a("<ul></ul>").addClass(this.options.containerClass+"-items").appendTo(this.container);a(document).keydown(function(f){c.onKeyDown(f)}).click(function(g){if(!c.currentFocus){return}if(g.target.className.indexOf(c.options.containerClass)>-1){if(c.container.index(g.target)>-1){return}var f=a(g.target).parents("."+c.options.containerClass);if(f.index(c.container)>-1){return}}c.blur()});if(this.options.autocomplete){this.autocomplete=new b.AutoComplete(this,this.options)}this.add("input");this.loadOriginal()},setValues:function(d){this.removeAll();var c=this;a.each(d,function(e,f){c.addBox(f)})},removeAll:function(){var c=[];a.each(this.elements,function(){if(this.is("box")){c.push(this)}});a.each(c,function(){this.remove()})},setAutocompleteValues:function(c){if(!this.options.autocomplete){return}if(typeof c=="string"){this.autocomplete.setValues(c.split(this.options.separator))}else{this.autocomplete.setValues(c)}},onKeyDown:function(d){if(!this.currentFocus){return}var g=this.currentFocus.is("input")?this.currentFocus.getCaret():null;var f=this.currentFocus.getValue();var e=(this.currentFocus.is("input")&&this.currentFocus.isSelected());this.currentFocus.valueContainer.focus();var c=f.length;switch(d.keyCode){case 32:if(this.currentFocus.is("box")||(g==f.length&&!e)){d.preventDefault();this.focusRelative("next")}c=0;break;case 37:if(this.currentFocus.is("box")||((g==0||!f.length)&&!e)){d.preventDefault();this.focusRelative("previous")}c=0;break;case 39:if(this.currentFocus.is("box")||(g==f.length&&!e)){d.preventDefault();this.focusRelative("next")}c=0;break;case 8:if(this.currentFocus.is("box")){this.currentFocus.remove();Comments.makeBadWordsRed();d.preventDefault()}else{if((g==0||!f.length)&&!e){this.focusRelative("previous");d.preventDefault()}}break;case 27:this.blur();break}},create:function(d,e,c){var f;if(d=="box"){f=new b.BoxElement(e,this,c)}else{if(d=="input"){f=new b.InputElement(e,this,c)}else{}}return f},getElementIndex:function(c){return a(this.elements).index(c)},getElement:function(c){if((c<0)||(c>this.elements.length-1)){return null}return this.elements[c]},getElementsByType:function(d){var c=[];a.each(this.elements,function(){if(this.is(d)){c.push(this)}});return c},getLastBox:function(){for(var c=this.elements.length-1;c>-1;c--){if(this.elements[c].is("box")){return this.elements[c]}}return null},insertElement:function(e,c){var d=(arguments.length>1)?c:this.elements.length;this.elements.splice(d,0,e)},add:function(f,g,e,c){var f=f||"box";var g=g||"";var c=c||"after";var e=e||this.getLastBox();var h=this.create(f,g);var d=0;if(e){d=this.getElementIndex(e)+((c=="after")?1:0)}this.insertElement(h,d);e?h.inject(e,c):h.inject();if(f=="box"){Comments.makeBadWordsRed()}return h},addBox:function(e,d,c){if(!a.trim(e).length){return}return this.add("box",a.trim(e),d,c)},removeBox:function(e){var d=null;a.each(this.elements,function(){if(this.getValue()==e){d=this;return false}});if(!d&&!isNaN(e)){var c=this.getElementsByType("box");if(c.length>e){d=c[e]}}if(d){d.remove()}},handleElementEvent:function(d,e,c){switch(d){case"add":this.onElementAdd(e,c);break;case"focus":this.onElementFocus(e,c);break;case"blur":this.onElementBlur(e,c);break;case"remove":this.onElementRemove(e,c);break}},onElementAdd:function(f){if(this.autocomplete){this.autocomplete.setupElement(f)}if(f.is("box")){var d=this.getElementIndex(f);var e=this.getElement(d-1);if((e&&e.is("box"))||(!e)){var c=this.add("input","",f,"before");if(this.options.hideEmptyInputs){c.hide()}}if(this.options.updateOriginal){this.updateOriginal()}if(this.options.onElementAdd){this.options.onElementAdd(f,this)}}},onElementFocus:function(c){if(this.currentFocus==c){return}if(this.currentFocus){this.currentFocus.blur()}this.currentFocus=c;if(this.currentFocus.is("input")&&this.autocomplete){this.autocomplete.search(this.currentFocus)}if(this.options.onElementFocus){this.options.onElementFocus(c,this)}},onElementBlur:function(c){if(this.currentFocus==c){this.currentFocus=null;if(this.autocomplete){this.autocomplete.hide()}if(this.options.onElementBlur){this.options.onElementBlur(c,this)}}},onElementRemove:function(d){var c=this.getElementIndex(d);this.focusRelative((c==this.elements.length-1)?"previous":"next",d);this.elements.splice(c,1);if(this.getElement(c)&&this.getElement(c).is("input")){if((this.getElement(c+1)&&this.getElement(c+1).is("input"))||(this.getElement(c-1)&&this.getElement(c-1).is("input"))){this.getElement(c).remove()}}if(this.options.updateOriginal){this.updateOriginal()}if(this.elements.length==1&&this.elements[0].is("input")){this.elements[0].show()}if(this.options.onElementRemove){this.options.onElementRemove(d,this)}},blur:function(){a.each(this.elements,function(c,d){d.blur()})},focusLast:function(){this.elements[this.elements.length-1].focus()},focusRelative:function(e,f){var d=f||this.currentFocus;var c=a(this.elements).index(d);c=(e=="previous")?c-1:c+1;if(c<0){return}if(c>=this.elements.length){return}this.elements[c].focus();if(this.elements[c].is("input")){(e=="previous")?this.elements[c].setCaretToEnd():this.elements[c].setCaretToStart()}},getBoxValues:function(){var c=[];a.each(this.elements,function(d,e){if(!this.is("box")){return}c.push(this.getValue())});return c},containsValue:function(c){return(a(this.getBoxValues()).index(c)>-1)},serialize:function(){return this.getBoxValues().join(this.options.separator)},updateOriginal:function(){this.original.attr("value",this.serialize())},loadOriginal:function(){this.load(this.original.attr("value"))},load:function(c){if(typeof c=="string"){var c=c.split(this.options.separator)}this.setValues(c)}});b.AutoComplete=b.BaseClass.extend({_options:{},construct:function(d,e){this.symbols=[];this.symbols["!!"]=["!!"];this.symbols["??"]=["??"];this.symbols[":-"]=[":-)",":-(",":-/",":-P",":-D",":->"];this.symbols[";-"]=[";-)"];this.symbols[":)"]=[":)"];this.symbols[":("]=[":("];this.symbols[":P"]=[":P"];this.symbols[":D"]=[":D"];this.symbols[";)"]=[";)"];this.symbols["X-"]=["X-)"];this.stb=d;this.currentValue="";this.options={};a.extend(this.options,this._options);a.extend(this.options,e||{});if(this.options.autocompleteUrl){this.ajaxLoad(this.options.autocompleteUrl)}else{this.setValues(this.options.autocompleteValues)}var c=this;this.baseClass=this.stb.options.containerClass+"-autocomplete";this.container=a("<div></div>").addClass(this.baseClass).css("width",this.stb.container.width()).appendTo(this.stb.container);this.placeHolder=a("<div></div>").addClass(this.baseClass+"-placeholder").html(this.options.placeholder).appendTo(this.container).hide();this.resultList=a("<div></div>").addClass(this.baseClass+"-results").appendTo(this.container).hide()},ajaxLoad:function(d){var c=this;a.get(d,{},function(f){var e=f.values;c.setValues(e)},"json")},setValues:function(c){this.values=c||[]},getValues:function(c){if(c){c=c.substr(0,1).toLowerCase()+c.substr(1,1);return this.values[c]||[]}else{return[]}},setupElement:function(d){if(!d.is("input")){return}var c=this;d.valueContainer.keydown(function(f){c.navigate(f)}).keyup(function(){c.search()})},navigate:function(c){switch(c.keyCode){case 38:(this.currentSelection&&this.currentSelection.prev().length)?this.focusRelative("prev"):this.blur();break;case 40:this.currentSelection?this.focusRelative("next"):this.focusFirst();break;case 13:if(this.currentSelection&&this.resultList.is(":hidden")==false){c.stopPropagation();this.addCurrent();this.currentElem.focus();this.search()}break}},search:function(c){if(c){this.currentElem=c}window.clearTimeout(this.hidetimer);var d=this.currentElem.getValue();if(d.length<this.options.minSearchLength){this.showPlaceHolder()}if(d==this.currentValue){return}this.currentValue=d;this.hideResultList();if(d.length<this.options.minSearchLength){return}this.showResults(d)},showPlaceHolder:function(){if(this.placeHolder){this.placeHolder.show()}},hidePlaceHolder:function(){if(this.placeHolder){this.placeHolder.hide()}},showResultList:function(){this.resultList.show()},hideResultList:function(){this.resultList.hide()},hide:function(){var c=this;this.hidetimer=window.setTimeout(function(){c.hidePlaceHolder();c.hideResultList();c.currentValue=""},150)},showResults:function(e){var d=this.searchResults(e);this.hidePlaceHolder();if(!d.length){return}this.blur();this.resultList.empty().show();var c=this;d.sort();a.each(d,function(f,g){c.addResult(g,e)});this.results=d},searchResults:function(f){if(typeof(this.symbols[f.substr(0,2)])!="undefined"&&(a.inArray(f,this.symbols[f.substr(0,2)])!=-1||this.symbols[f.substr(0,2)].length>0)){if(f.substr(0,2)==f){g=this.symbols[f.substr(0,2)]}else{var g=[];g.push(f)}}else{var g=[],e=new RegExp((this.options.fullSearch?"":"\\b")+f,this.caseSensitive?"":"i");var c=this.getValues(f);for(var d=0;d<c.length;d++){if(this.stb.options.uniqueValues&&this.stb.containsValue(c[d])){continue}if(e.test(c[d])){g.push(c[d])}if(g.length>=this.options.maxResults){break}}}return g},addResult:function(c,f){var e=this;var d=a("<div></div>").addClass(this.baseClass+"-result").appendTo(this.resultList).mouseenter(function(i){e.focus(this)}).mousedown(function(i){i.stopPropagation();window.clearTimeout(e.hidetimer);e.doAdd=true}).mouseup(function(i){if(e.doAdd){e.addCurrent();e.currentElem.focus();e.search();e.doAdd=false}});var h=a("<span>").addClass(e.baseClass+"-value").html(f+c.substr(f.length,c.length)).css("display","none").appendTo(d);var g=a("<span>").addClass(e.baseClass+"-display").html(e.formatResult(c,f)).appendTo(d)},formatResult:function(d,g){if(this.options.highlight){var e=d.toLowerCase();var h=g.toLowerCase();var c=e.indexOf(h);var f="<span>"+d.substring(0,c)+"</span><span class='"+this.baseClass+"-highligh'>"+d.substring(c,c+g.length)+"</span><span>"+d.substring(c+g.length)+"</span>";return f}else{return g+d.substr(g.length,d.length)}},addCurrent:function(){var c=a("."+this.baseClass+"-value",this.currentSelection).html();this.currentElem.setValue(c);this.currentElem.saveAsBox();this.currentSelection=null},focus:function(c){this.blur();this.currentSelection=a(c).addClass(this.baseClass+"-result-focus")},focusFirst:function(){this.focus(this.resultList.children(":first"))},focusRelative:function(c){if(c=="next"){this.focus(this.currentSelection.next().length?this.currentSelection.next():this.currentSelection)}else{this.focus(this.currentSelection.prev().length?this.currentSelection.prev():this.currentSelection)}},blur:function(){if(this.currentSelection){this.currentSelection.removeClass(this.baseClass+"-result-focus");this.currentSelection=null}}});b.GrowingInput=b.BaseClass.extend({options:{min:0,max:null,startWidth:2,correction:10},construct:function(e,f){var f=f||{};a.extend(this.options,f);var c=this;this.element=a(e);this.calc=a("<span></span>").css({"float":"left",display:"inline-block",position:"absolute",left:-1000}).insertAfter(this.element);this.requiredStyles=["font-size","font-family","padding-left","padding-top","padding-bottom","padding-right","border-left","border-right","border-top","border-bottom","word-spacing","letter-spacing","text-indent","text-transform"];this.copyCat();this.resize();var d=function(){c.resize()};this.element.click(d).blur(d).keyup(d).keydown(d).keypress(d)},copyCat:function(){var c=this;a.each(this.requiredStyles,function(d,e){c.calc.css(e,c.element.css(e))})},calculate:function(d){this.calc.html(d);var c=this.calc.width();return(c?c:this.options.startWidth)+this.options.correction},resize:function(){this.lastvalue=this.value;this.value=this.element.attr("value");var e=this.value;if((this.options.min||(this.options.min==0))&&this.value.length<this.options.min){if((this.lastvalue||(this.lastvalue==0))&&(this.lastvalue.length<=this.options.min)){return}for(var c=0;c<this.options.min;c++){e+="-"}}if((this.options.max||(this.options.max==0))&&this.value.length>this.options.max){if((this.lastvalue||(this.lastvalue==0))&&(this.lastvalue.length>=this.options.max)){return}e=this.value.substr(0,this.options.max)}var d=this.calculate(e);this.element.width(d);return this}});b.BaseElement=b.BaseClass.extend({type:"base",options:{},construct:function(d,c,e){var e=e||{};a.extend(this.options,e);this.value=d;this.stb=c;this.className=this.stb.options.containerClass+"-elem";this.elemClassName=this.stb.options.containerClass+"-"+this.type+"-elem";this.focused=false;this.init()},init:function(){this.constructElement()},constructElement:function(){this.el=null},is:function(c){return this.type==c},inject:function(c,d){if(c){(d=="before")?this.getElement().insertBefore(c.getElement()):this.getElement().insertAfter(c.getElement())}else{this.getElement().prependTo(this.stb.list)}this.notifyEvent("add")},remove:function(c){this.blur();this.el.remove();this.onRemove();var d=(typeof c=="undefined")?true:c;if(d){this.notifyEvent("remove")}},focus:function(c){if(this.focused){return this}this.show();this.el.addClass(this.className+"-focus").addClass(this.className+"-"+this.type+"-focus");this.focused=true;var d=(typeof c=="undefined")?true:c;if(d){this.notifyEvent("focus")}this.onFocus();return this},blur:function(c){if(!this.focused){return this}this.el.removeClass(this.className+"-focus").removeClass(this.className+"-"+this.type+"-focus");this.focused=false;var d=(typeof c=="undefined")?true:c;if(d){this.notifyEvent("blur")}this.onBlur();return this},onMouseIn:function(){this.el.addClass(this.className+"-hover").addClass(this.className+"-"+this.type+"-hover")},onMouseOut:function(){this.el.removeClass(this.className+"-hover").removeClass(this.className+"-"+this.type+"-hover")},onFocus:function(){return},onBlur:function(){return},onRemove:function(){return},show:function(c){this.el.show();var d=(typeof c=="undefined")?true:c;if(d){this.notifyEvent("show")}return this},hide:function(c){this.el.hide();var d=(typeof c=="undefined")?true:c;if(d){this.notifyEvent("hide")}return this},setValue:function(c,d){this.value=c;this.valueContainer.text(c);var e=(typeof d=="undefined")?true:d;if(e){this.notifyEvent("setValue")}return this},getValue:function(){return this.value},getElement:function(){return this.el},notifyEvent:function(c){this.stb.handleElementEvent(c,this);return this},toString:function(){return"[BoxElement type='"+this.type+"' value='"+this.getValue()+"']"}});b.BoxElement=b.BaseElement.extend({type:"box",constructElement:function(){var c=this;this.el=a("<li></li>").addClass(this.className).addClass(this.elemClassName).hover(function(){c.onMouseIn()},function(){c.onMouseOut()}).mousedown(function(d){c.focus()});if(this.stb.options.editOnDoubleClick){this.el.dblclick(function(d){d.preventDefault();c.toInput()})}this.valueContainer=a("<span></span>").addClass(this.className+"-valueContainer").appendTo(this.el);this.removeButton=a("<a></a>").addClass(this.className+"-deleteButton").attr("href","javascript:;").click(function(d){c.remove();d.stopPropagation()});this.setValue(this.value)},onFocus:function(){var c=this;if(this.stb.options.editOnFocus){window.setTimeout(function(){c.toInput()},50)}},onBlur:function(){return},toInput:function(){var e=this.getValue();var d=this.stb.getElementIndex(this);this.remove();var c=this.stb.getElement(d-1);if(c.is("input")&&!a.trim(c.getValue()).length){c.setValue(e);c.valueContainer.focus();c.setCaretToEnd()}}});b.InputElement=b.BaseElement.extend({type:"input",onPaste:"return false",constructElement:function(){var c=this;this.el=a("<li></li>").addClass(this.className).addClass(this.elemClassName).hover(function(){c.onMouseIn()},function(){c.onMouseOut()}).click(function(){c.focus()});this.valueContainer=a("<input />").addClass(this.elemClassName+"-valueInput").focus(function(d){d.stopPropagation();c.focus()}).blur(function(d){c.blur()}).appendTo(this.el).bind("paste",function(){return false});this.growingInput=new b.GrowingInput(this.valueContainer);a(document).keydown(function(d){c.onKeyDown(d)});a(document).keypress(function(d){c.onKeyPress(d)});this.setValue(this.value)},getValue:function(){return this.valueContainer.attr("value")},setValue:function(c){this.value=c;this.valueContainer.attr("value",c);this.growingInput.resize();this.notifyEvent("setValue");return this},getCaret:function(){var d=this.valueContainer[0];if(d.createTextRange){var c=document.selection.createRange().duplicate();c.moveEnd("character",d.value.length);if(c.text===""){return d.value.length}return d.value.lastIndexOf(c.text)}else{return d.selectionStart}},getCaretEnd:function(){var d=this.valueContainer[0];if(d.createTextRange){var c=document.selection.createRange().duplicate();c.moveStart("character",-d.value.length);return c.text.length}else{return d.selectionEnd}},setCaret:function(e){var c=this.valueContainer[0];if(c.createTextRange){c.focus();var d=document.selection.createRange();d.moveStart("character",-c.value.length);d.moveStart("character",e);d.moveEnd("character",0);d.select()}else{c.selectionStart=e;c.selectionEnd=e}},setCaretToStart:function(){this.setCaret(0)},setCaretToEnd:function(){this.setCaret(this.valueContainer.attr("value").length||0)},isSelected:function(){return this.focused&&(this.getCaret()!==this.getCaretEnd())},saveAsBox:function(){var d=this.getValue();var c=d.substr(0,1).toLowerCase()+d.slice(1);var e=c.substr(c.length-1,1);if(d.length>1&&(e=="."||e==","||e=="?"||e=="!"||e==":")){c=c.substr(0,c.length-1)}if(!d||a.inArray(c,this.stb.options.autocompleteValues[c.substr(0,2)])==-1){return}this.stb.add("box",a.trim(d),this,"before");this.setValue("")},onKeyDown:function(c){if(!this.focused){return}if(c.keyCode==13&&this.getValue().length==0){Comments.addCommentEvent(c)}if(a.inArray(c.keyCode,this.stb.options.submitKeys)>-1&&!this.stb.options.onlyAutocomplete&&!(this.stb.options.uniqueValues&&this.stb.containsValue(this.getValue()))){c.preventDefault();this.saveAsBox()}},onKeyPress:function(c){if(!this.focused){return}if(a.inArray(String.fromCharCode(c.charCode||c.keyCode||0),this.stb.options.submitChars)>-1&&!this.stb.options.onlyAutocomplete&&!(this.stb.options.uniqueValues&&this.stb.containsValue(this.getValue()))){c.preventDefault();this.saveAsBox()}},onFocus:function(){this.show();this.valueContainer.focus();this.growingInput.resize()},onBlur:function(){this.valueContainer.blur();if(this.stb.options.hideEmptyInputs&&this.el.next().length&&!this.getValue()){this.hide()}if(this.stb.options.editOnFocus){this.saveAsBox()}}});a.fn.extend({smartTextBox:function(c,d){return this.each(function(){var e=a(this).data("SmartTextBox");if(e){switch(c){case"add":e.addBox(d);break;case"remove":e.removeBox(d);break;case"load":e.load(d);break;case"clear":e.removeAll();break;case"autocomplete":e.setAutocompleteValues(d);break}}else{new a.SmartTextBox.SmartTextBox(this,c)}})}})})(jQuery);